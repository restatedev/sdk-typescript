name: Test Deno Template

on:
  workflow_call:

env:
  RESTATE_IDENTITY_KEYS: "publickeyv1_8yHkhqyKeDaLytykZnKqrEQK27wF5A569edCqc5Vq2VH"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Start Restate
        run: |
          docker run -d --name restate \
            -p 8080:8080 -p 9070:9070 \
            -v ${{ github.workspace }}/test/fixtures/request-signing:/etc/restate-signing:ro \
            -e RESTATE_REQUEST_IDENTITY_PRIVATE_KEY_PEM_FILE=/etc/restate-signing/private.pem \
            -e DO_NOT_TRACK=true \
            --add-host=host.docker.internal:host-gateway \
            docker.restate.dev/restatedev/restate:latest

          # Wait for Restate to be healthy
          timeout 60 bash -c 'until curl -sf http://localhost:9070/health; do sleep 2; done'
          echo "Restate is ready!"

      - name: Install Deno dependencies
        working-directory: packages/examples/deno
        run: deno install

      - name: Start Deno service
        working-directory: packages/examples/deno
        run: |
          deno task start &
          echo $! > service.pid
          sleep 5

      - name: Register with Restate
        run: |
          curl -X POST http://localhost:9070/deployments \
            -H 'content-type: application/json' \
            -d '{"uri": "http://host.docker.internal:9080"}'

      - name: Test Deno template
        run: |
          echo "Testing Greeter service (with request signing)..."
          RESPONSE=$(curl -s localhost:8080/Greeter/greet --json '{"name": "Deno"}')
          echo "Response: $RESPONSE"

          # Check if response contains expected message
          if echo "$RESPONSE" | grep -q "You said hi to Deno!"; then
            echo "✅ Test passed!"
          else
            echo "❌ Test failed! Expected: { result: You said hi to Deno! }"
            exit 1
          fi

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Restate logs ==="
          docker logs restate

          echo "=== Service logs ==="
          if [ -f packages/examples/deno/service.pid ]; then
            ps aux | grep deno || true
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ -f packages/examples/deno/service.pid ]; then
            kill $(cat packages/examples/deno/service.pid) || true
          fi
          docker stop restate || true
          docker rm restate || true
